#!/usr/bin/env python
# pylint: disable=invalid-name
"""Build a service the __init__.py module that imports latest service client."""

import argparse
import json
import os
import sys

from botocore.client import ServiceModel
from botocore.utils import get_service_module_name

INIT_TEMPLATE = '''\
# THIS FILE IS AUTO-GENERATED. DO NOT EDIT THIS FILE BY HAND.
from botocore._clients.{service_name}.v{api_version}.service import {class_name}
'''


def main(args):
    parser = argparse.ArgumentParser()
    parser.add_argument('specs', nargs='+')
    parser.add_argument('output_file')
    args = parser.parse_args(args)

    models = []
    for spec in args.specs:
        with open(spec, 'r') as spec_file:
            models.append(ServiceModel(json.load(spec_file)))

    # TODO: check that all specs are for the same service
    service_name = os.path.basename(
        os.path.dirname(os.path.dirname(args.specs[0]))
    )

    latest_model = max(models, key=lambda x: x.api_version)
    with open(args.output_file, 'w') as output:
        output.write(
            INIT_TEMPLATE.format(
                service_name=service_name,
                api_version=latest_model.api_version.replace('-', '_'),
                class_name=get_service_module_name(latest_model),
            )
        )


if __name__ == '__main__':
    main(sys.argv[1:])
